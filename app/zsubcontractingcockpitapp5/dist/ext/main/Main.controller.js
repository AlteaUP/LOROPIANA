sap.ui.define(["sap/fe/core/PageController","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/MessageToast"],function(e,t,a,i){"use strict";var r;return e.extend("zsubcontractingcockpitapp5.ext.main.Main",{onInit:function(){r=this;e.prototype.onInit.apply(this,arguments)},onBeforeRendering:function(){r._mainService=r.getOwnerComponent().getModel()},onAfterRendering:function(){r._mainService=r.getOwnerComponent().getModel()},closeCreateMaterialDocumentsDialog:function(){r.pManualNumberingDialog.close()},loadTableData:function(e){var t=e.getParameter("collectionBindingInfo");t.collectionBindingInfo.events={dataReceived:function(e){var t=e.getParameter("data")}}},onCreateMaterialDocuments:function(e){if(r.pManualNumberingDialog===null||r.pManualNumberingDialog===undefined){r.pManualNumberingDialog=sap.ui.xmlfragment(this.getView().getId(),"zsubcontractingcockpitapp5.ext.Fragment.MaterialDocumentCreation",r);r.getView().addDependent(r.pManualNumberingDialog)}r.pManualNumberingDialog.open();if(e.getParameters().id.indexOf("customAction2")>-1){r.byId("lgort1ID").setVisible(true);r.byId("lgort2ID").setVisible(false);r.byId("ManualAccountingDialog").data("buttonPressed","HUB")}else{r.byId("lgort1ID").setVisible(false);r.byId("lgort2ID").setVisible(true);r.byId("ManualAccountingDialog").data("buttonPressed","factory")}var a=[];var i=false;for(var l=0;l<r.byId("TableOrderId").getSelectedContexts().length;l++){if(r.byId("TableOrderId").getSelectedContexts()[l].getObject().requirementtype==="BB"&&r.byId("ManualAccountingDialog").data("buttonPressed")==="factory"){i=true}a.push(r.byId("TableOrderId").getSelectedContexts()[l].getObject());if(r.byId("TableOrderId").getSelectedContexts()[l].getObject().requirementtype==="BB"&&r.byId("ManualAccountingDialog").data("buttonPressed")==="factory"){if(a[l].QtyToIssue>a[l].AvaibilityQtyProdStorage){a[l].QtyToIssue=a[l].AvaibilityQtyProdStorage}}else if(r.byId("TableOrderId").getSelectedContexts()[l].getObject().requirementtype==="BB"&&r.byId("ManualAccountingDialog").data("buttonPressed")==="HUB"){if(a[l].QtyToIssue>a[l].AvaibilityQtyProdStorage){a[l].TotalWithdrawnQuantity=a[l].AvaibilityQtyProdStorage}else{a[l].TotalWithdrawnQuantity=a[l].QtyToIssue}a[l].QtyToIssue=Number(a[l].QtyToIssue)-Number(a[l].AvaibilityQtyProdStorage);if(a[l].QtyToIssue<0){a[l].QtyToIssue=0}}}if(i){r.byId("shippingPointID").setRequired(false)}else{r.byId("shippingPointID").setRequired(true)}var n=r.byId("selectedMaterialTableId");var o=new t;o.setData({SelectedMaterial:a});n.setModel(o)},zeroPad:function(e,t){return e.toString().padStart(t,"0")},onConfirmMaterialDocumentCreationDialog:async function(){if(!this.byId("shippingPointID").getRequired()||this.byId("shippingPointID").getValue()!==null&&this.byId("shippingPointID").getValue()!==undefined&&this.byId("shippingPointID").getValue()!==""){var e=new sap.m.BusyDialog;e.open();var t=r.byId("ManualAccountingDialog").data();var a=[];var l={};for(var n=0;n<this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial.length;n++){if(this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].requirementtype==="BB"&&this.byId("ManualAccountingDialog").data("buttonPressed")==="factory"){var o=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].QtyToIssue;const t=r.getView().getModel();const a=t.bindList("/ZZ1_I_UNION_SUBCONCTR_COMP");const i=new sap.ui.model.Filter("Material","EQ",this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Material);const l=new sap.ui.model.Filter("CprodOrd","EQ",this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].CprodOrd);const u=new sap.ui.model.Filter("Batch","EQ",this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Batch);a.filter([l,i,u]);const c=await a.requestContexts(0,20);var d=c.map(e=>e.getObject());const g=r.getView().getModel();let M={};M.Material=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Material;M.Supplier=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Supplier;var s=g.bindContext("/GetMaterialStock(...)");s.setParameter("Object",M);await s.execute().then(async()=>{var t=s.getBoundContext();var a=t.getObject().value;let i={};let l=[];var n=0;var u=0;for(var c=0;c<d.length;c++){if(n<=Number(o)){let e=Number(d[c].RequiredQuantity-d[c].WithdrawnQuantity);for(var g=0;g<a.length;g++){if(e>0&&n<=Number(o)){if(e<Number(a[g].MatlWrhsStkQtyInMatlBaseUnit)&&e<Number(o)){i={};i.MasterProductionOrder=d[c].MasterProductionOrder;if(a[g].Batch!==undefined&&a[g].Batch!==null&&a[g].Batch!==""){i.Batch=r.zeroPad(a[g].Batch,10)}else{i.Batch=a[g].Batch}i.Quantity=e;i.Material=d[c].Material;i.Plant=d[c].Plant;i.CprodOrd=d[c].CprodOrd;i.UnitMeasure=d[c].BaseUnit;i.PurchaseOrder=d[c].PurchaseOrder;i.PurchaseOrderItem=d[c].PurchaseOrderItem;i.Supplier=r.zeroPad(d[c].Supplier,10);i.ManufacturingOrder=r.zeroPad(d[c].ManufacturingOrder,12);i.ManufacturingOrderOperation=d[c].ManufacturingOrderOperation;l.push(i);a[g].MatlWrhsStkQtyInMatlBaseUnit=a[g].MatlWrhsStkQtyInMatlBaseUnit-e;e=e-i.Quantity;n=Number(n)+Number(i.Quantity);u=Number(o)-n}else{if(a[g].MatlWrhsStkQtyInMatlBaseUnit>0){i={};i.MasterProductionOrder=d[c].MasterProductionOrder;if(a[g].Batch!==undefined&&a[g].Batch!==null&&a[g].Batch!==""){i.Batch=r.zeroPad(a[g].Batch,10)}else{i.Batch=a[g].Batch}if(n>=Number(a[g].MatlWrhsStkQtyInMatlBaseUnit)){i.Quantity=u}else{i.Quantity=Number(a[g].MatlWrhsStkQtyInMatlBaseUnit)}i.Material=d[c].Material;i.Plant=d[c].Plant;i.CprodOrd=d[c].CprodOrd;i.UnitMeasure=d[c].BaseUnit;i.PurchaseOrder=d[c].PurchaseOrder;i.PurchaseOrderItem=d[c].PurchaseOrderItem;i.Supplier=r.zeroPad(d[c].Supplier,10);i.ManufacturingOrder=r.zeroPad(d[c].ManufacturingOrder,12);i.ManufacturingOrderOperation=d[c].ManufacturingOrderOperation;l.push(i);e=e-a[g].MatlWrhsStkQtyInMatlBaseUnit;a[g].MatlWrhsStkQtyInMatlBaseUnit=a[g].MatlWrhsStkQtyInMatlBaseUnit-i.Quantity;n=Number(n)+Number(i.Quantity);u=Number(o)-n}}if(Number(u)===0){break}}}}else{break}}console.log("finito di creare array");const M=r.getView().getModel();var p=M.bindContext("/CreateMaterialDocument(...)");await p.setParameter("Record",l);p.execute().then(t=>{e.close();r.openDialogMessageText("","I")}).catch(t=>{e.close();r.openDialogMessageText("","E")})}).catch(t=>{e.close()})}else{l={};l.Material=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Material;l.Batch=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Batch;l.Stock=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].StockMaterial;l.Quantity=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].QtyToIssue;l.CprodOrd=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].CprodOrd;l.CprodOrd=r.zeroPad(l.CprodOrd,12);l.UnitMeasure=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].EntryUnit;l.Plant=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Plant;l.WorkCenterInternalID=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].WorkCenterInternalID;if(this.byId("ManualAccountingDialog").data("buttonPressed")==="HUB"){l.Lgort=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Lgort1}else{l.Lgort=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Lgort2}l.Vstel=this.byId("shippingPointID").getValue();l.Supplier=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Supplier;if(this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].requirementtype==="BB"){l.Bwart="541";l.Lfart="LB";l.Customer=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Customer;l.Supplier=this.byId("selectedMaterialTableId").getModel().getData().SelectedMaterial[n].Supplier}else{if(this.byId("ManualAccountingDialog").data("buttonPressed")==="HUB"){l.Bwart="313"}else{l.Bwart="311"}l.Lfart="ZHOD"}a.push(l)}}var u=r._mainService.sServiceUrl;const i=r.getView().getModel();const c=i.bindContext("/CreateDelivery(...)");c.setParameter("Record",a);c.execute().then(t=>{e.close();r.openDialogMessageText("","I")}).catch(t=>{e.close();r.openDialogMessageText("","E")});r.pManualNumberingDialog.close()}else{i.show(r.getResourceBundle().getText("vstelMandatory"))}},onCloseMaterialDocumentCreationDialog:function(){r.pManualNumberingDialog.close()},getResourceBundle:function(){return r.getOwnerComponent().getModel("i18n").getResourceBundle()},openDialogMessageText:function(e,t){var i="Message";var r="Error";if(t==="E"){i=this.getResourceBundle().getText("errorTitle");r="Error"}else if(t==="I"){i=this.getResourceBundle().getText("successTitle");r="Success"}var l=new a({title:i,type:"Message",state:r,content:new sap.m.Text({text:e}),beginButton:new sap.m.Button({text:"OK",press:function(){l.close()}}),afterClose:function(){l.destroy()}});l.open()},onValueHelpRequestShippingPoint:function(e){this.byId("shippingPointID").setValue();if(r.pShippingPointDialog===null||r.pShippingPointDialog===undefined){r.pShippingPointDialog=sap.ui.xmlfragment(this.getView().getId(),"zsubcontractingcockpitapp5.ext.Fragment.ShippingPointList",r);r.getView().addDependent(r.pShippingPointDialog)}r.pShippingPointDialog.open()},onValueHelpShippingPointConfirm:function(e){var t=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!t){return}this.byId("shippingPointID").setValue(t.getTitle());r.pShippingPointDialog.close()},onValueHelpShippingPointClose:function(e){r.pShippingPointDialog.close()},onValueHelpShippingPointSearch:function(e){var t=e.getParameter("value");var a=new Filter("Name",FilterOperator.Contains,t);e.getSource().getBinding("items").filter([a])}})});
//# sourceMappingURL=Main.controller.js.map